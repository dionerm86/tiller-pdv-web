<div class="dialog-header">
  <div class="header-content">
    <h2>
      <mat-icon>receipt_long</mat-icon>
      Detalhes da Venda
    </h2>
    <mat-chip [class.chip-success]="venda.status === 'Concluida'"
              [class.chip-danger]="venda.status === 'Cancelada'">
      {{ venda.status }}
    </mat-chip>
  </div>
  <button mat-icon-button (click)="fechar()">
    <mat-icon>close</mat-icon>
  </button>
</div>

<mat-dialog-content>
  <!-- Informações Principais -->
  <div class="info-section">
    <div class="info-grid">
      <div class="info-item">
        <span class="label">Número da Venda</span>
        <span class="value"><strong>{{ venda.numeroVenda }}</strong></span>
      </div>
      <div class="info-item">
        <span class="label">Data/Hora</span>
        <span class="value">{{ venda.dataHora | date:'dd/MM/yyyy HH:mm:ss' }}</span>
      </div>
      <div class="info-item">
        <span class="label">Caixa</span>
        <span class="value">Caixa #{{ venda.caixaId }}</span>
      </div>
      <div class="info-item">
        <span class="label">Vendedor</span>
        <span class="value">{{ venda.usuario?.nome }}</span>
      </div>
      <div class="info-item">
        <span class="label">Cliente</span>
        <span class="value">{{ venda.cliente?.nome || 'Consumidor Final' }}</span>
      </div>
      <div class="info-item">
        <span class="label">Forma de Pagamento</span>
        <span class="value">
          <mat-chip [class]="'chip-' + venda.formaPagamento">
            {{ formatarFormaPagamento(venda.formaPagamento) }}
          </mat-chip>
        </span>
      </div>
    </div>
  </div>

  <mat-divider></mat-divider>

  <!-- Itens da Venda -->
  <div class="itens-section">
    <h3>
      <mat-icon>shopping_cart</mat-icon>
      Itens da Venda
    </h3>

    <table mat-table [dataSource]="venda.itens" class="itens-table">
      <ng-container matColumnDef="descricao">
        <th mat-header-cell *matHeaderCellDef>Produto</th>
        <td mat-cell *matCellDef="let item">
          <strong>{{ item.descricao }}</strong>
          <br>
          <small class="codigo">Código: {{ item.produtoId }}</small>
        </td>
      </ng-container>

      <ng-container matColumnDef="quantidade">
        <th mat-header-cell *matHeaderCellDef>Qtd</th>
        <td mat-cell *matCellDef="let item">{{ item.quantidade }}</td>
      </ng-container>

      <ng-container matColumnDef="precoUnitario">
        <th mat-header-cell *matHeaderCellDef>Preço Unit.</th>
        <td mat-cell *matCellDef="let item">
          R$ {{ item.precoUnitario | number:'1.2-2' }}
        </td>
      </ng-container>

      <ng-container matColumnDef="desconto">
        <th mat-header-cell *matHeaderCellDef>Desconto</th>
        <td mat-cell *matCellDef="let item" class="desconto">
          <span *ngIf="item.valorDesconto > 0">
            - R$ {{ item.valorDesconto | number:'1.2-2' }}
          </span>
          <span *ngIf="item.valorDesconto === 0">-</span>
        </td>
      </ng-container>

      <ng-container matColumnDef="subtotal">
        <th mat-header-cell *matHeaderCellDef>Subtotal</th>
        <td mat-cell *matCellDef="let item" class="subtotal">
          <strong>R$ {{ item.subtotal | number:'1.2-2' }}</strong>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
    </table>
  </div>

  <mat-divider></mat-divider>

  <!-- Totais -->
  <div class="totais-section">
    <div class="total-row">
      <span>Subtotal:</span>
      <span>R$ {{ venda.valorBruto | number:'1.2-2' }}</span>
    </div>
    <div class="total-row desconto" *ngIf="venda.valorDesconto > 0">
      <span>
        Desconto
        <span *ngIf="venda.percentualDesconto">({{ venda.percentualDesconto }}%)</span>:
      </span>
      <span>- R$ {{ venda.valorDesconto | number:'1.2-2' }}</span>
    </div>
    <mat-divider></mat-divider>
    <div class="total-row total-final">
      <span>TOTAL:</span>
      <span class="valor-total">R$ {{ venda.valorTotal | number:'1.2-2' }}</span>
    </div>

    <!-- Troco (se pagamento em dinheiro) -->
    <div class="troco-info" *ngIf="venda.formaPagamento === 'Dinheiro' && venda.valorPago">
      <div class="total-row">
        <span>Valor Pago:</span>
        <span>R$ {{ venda.valorPago | number:'1.2-2' }}</span>
      </div>
      <div class="total-row troco">
        <span>Troco:</span>
        <span>R$ {{ venda.valorTroco | number:'1.2-2' }}</span>
      </div>
    </div>

    <!-- Pagamentos Múltiplos -->
    <div class="pagamentos-multiplos" *ngIf="venda.pagamentos && venda.pagamentos.length > 0">
      <h4>Formas de Pagamento:</h4>
      <div class="pagamento-item" *ngFor="let pag of venda.pagamentos">
        <mat-chip>{{ pag.formaPagamento }}</mat-chip>
        <span>R$ {{ pag.valor | number:'1.2-2' }}</span>
        <small *ngIf="pag.nsu">NSU: {{ pag.nsu }}</small>
      </div>
    </div>
  </div>

  <!-- Informações Adicionais -->
  <div class="observacoes-section" *ngIf="venda.observacoes || venda.chaveNFCe">
    <mat-divider></mat-divider>
    <div class="obs-item" *ngIf="venda.observacoes">
      <strong>Observações:</strong>
      <p>{{ venda.observacoes }}</p>
    </div>
    <div class="obs-item" *ngIf="venda.chaveNFCe">
      <strong>Chave NFC-e:</strong>
      <p class="chave-nfce">{{ venda.chaveNFCe }}</p>
    </div>
  </div>

  <!-- Informações de Cancelamento -->
  <div class="cancelamento-section" *ngIf="venda.status === 'Cancelada'">
    <mat-divider></mat-divider>
    <div class="alert-cancelamento">
      <mat-icon>warning</mat-icon>
      <div>
        <strong>Venda Cancelada</strong>
        <p *ngIf="venda.dataCancelamento">
          Data: {{ venda.dataCancelamento | date:'dd/MM/yyyy HH:mm' }}
        </p>
        <p *ngIf="venda.motivoCancelamento">
          Motivo: {{ venda.motivoCancelamento }}
        </p>
      </div>
    </div>
  </div>
</mat-dialog-content>

<mat-dialog-actions align="end">
  <button mat-button (click)="fechar()">Fechar</button>
  <button mat-raised-button color="primary" (click)="imprimir()">
    <mat-icon>print</mat-icon>
    Imprimir
  </button>
</mat-dialog-actions>